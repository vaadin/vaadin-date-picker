  <dom-module id="vaadin-i18n-core">
    <template>
    </template>
    <script>
    Polymer({
      is: "vaadin-i18n-core",
      properties: {
        /**
         * Locale of the complete UI.
         * If undefined, it will use the locale defined in each component,
         * or eventually the use the default browser language.
         * Syntax: `en-gb`, `fi`, `es`, etc.
         */
        locale: {
          type: String,
          value: undefined,
          observer: '_localeChanged'
        },

        _elementsLoaded: {
          type: Array,
          value: []
        },

        _scriptsLoaded: {
          type: Array,
          value: []
        }
      },

      ready: function() {
        window.vaadin = window.vaadin || {};
        vaadin.elements = vaadin.elements || {};
        vaadin.elements.i18n = vaadin.elements.i18n || {};
        if (!vaadin.elements.i18n.handler) {
          vaadin.elements.i18n.handler = window.addEventListener('vaadin-i18n', this._onI18nEvent.bind(this));
        }
      },

      _localeChanged: function() {
        for (i in this._elementsLoaded) {
          this._i18nElement(this._elementsLoaded[i], this.locale);
        }
      },

      _onI18nEvent: function(ev) {
        var elem = ev.detail;
        var locale = this.locale ||Â elem.locale || navigator.language.toLowerCase();
        this._i18nElement(elem, locale);
        this._elementsLoaded.push(elem);
      },

      _i18nElement: function(elem, locale) {
        if (elem.locale != locale) {
          for (key in elem.i18n) {
            this._i18nKey(elem, locale, key);
          }
          elem.locale = locale;
        }
      },

      _setKey: function(elem, key, value) {
        elem.i18n[key] = value;
        elem.notifyPath('i18n.' + key, value);
      },

      _i18nKey: function(elem, locale, key) {
        if (key == 'moment') {
          this._loadLocaleMoment(locale, function() {
            elem.set('i18n.' + key, moment.localeData(locale));
          }.bind(this));
        } else if (key == 'weekdaysShort') {
          this._loadLocaleMoment(locale, function() {
            elem.set('i18n.' + key, moment.localeData(locale)._weekdaysShort);
          }.bind(this));
        } else if (key == 'monthNames') {
          this._loadLocaleMoment(locale, function() {
            elem.set('i18n.' + key, moment.localeData(locale)._months);
          }.bind(this));
        } else if (key == 'firstDayOfWeek') {
          this._loadLocaleMoment(locale, function() {
            elem.set('i18n.' + key, moment.localeData(locale)._week.dow);
          }.bind(this));
        } else if (key == 'today') {
          this._loadLocaleMoment(locale, function() {
            elem.set('i18n.' + key, moment().calendar(Date.now()).replace(/(.+?) .*/,'$1'));
          }.bind(this));
        }
      },

      _loadScript: function(src, done) {
        var onLoad = function() {
          Polymer.Base.async(done, 100);
        }.bind(this);
        if (this._scriptsLoaded[src]) {
          onLoad();
        } else {
          var scriptElem = document.createElement('script');
          scriptElem.src = src;
          scriptElem.onload = onLoad;
          document.head.appendChild(scriptElem);
          this._scriptsLoaded[src] = scriptElem;
        }
      },

      _loadMoment: function(done) {
        this._loadScript(this.resolveUrl('../moment/min/moment.min.js'), done);
      },

      _loadLocaleMoment: function(locale, done) {
        this._loadMoment(function() {
          this._loadScript(this.resolveUrl('../moment/locale/' + locale + '.js'), done);
        }.bind(this));
      },

    });
    </script>
  </dom-module>
