  <dom-module id="vaadin-i18n-core">
    <template>
    </template>
    <script>
    Polymer({
      is: "vaadin-i18n-core",
      properties: {
        /**
         * Locale of the complete UI.
         * If undefined, it will use default browser language, or locale
         * in each component using iternationalisation.
         * Syntax: `en-gb`, `fi`, `es`, etc.
         */
        locale: {
          type: String,
          value: undefined,
          observer: '_localeChanged'
        },

        _elementsLoaded: {
          type: Array,
          value: []
        },

        _scriptsLoaded: {
          type: Array,
          value: []
        }
      },

      ready: function() {
        window.vaadin = window.vaadin || {};
        vaadin.elements = vaadin.elements || {};
        vaadin.elements.i18n = vaadin.elements.i18n || {};
        if (!vaadin.elements.i18n) {
          vaadin.elements.i18n = addEventListener('vaadin-i18n', this._onI18nEvent);
        }
      },

      _localeChanged: function() {
        for (i in this._elementsLoaded) {
          _internationaliseElement(this._elementsLoaded[i], this.locale);
        }
      },

      _onI18nEvent: function(ev) {
        var elem = ev.detail;
        var locale = this.locale ||Â elem.locale || navigator.language.toLowerCase();
        _internationaliseElement(elem, locale);
      },

      _internationaliseElement(elem, locale) {
        if (elem._currentLocale != locale) {
          elem._currentLocale = locale;
          for (key in elem.i18n) {
            this._internationaliseKey(elem, locale, key);
          }
        }
      },

      _internationaliseKey: function(elem, locale, key) {
        this._weekDayNames = moment.localeData(locale)._weekdaysShort;
        this._monthNames = moment.localeData(locale)._months;
        this._firstDayOfWeek = moment.localeData(locale)._week.dow;

        if (key == 'moment') {
          this._loadLocaleMoment(locale, function() {
            this._setKey(elem, key, moment.localeData(locale));
          }.bind(this));
        } else if (key == 'weekdaysShort') {
          this._loadLocaleMoment(locale, function() {
            this._setKey(elem, key, moment.localeData(locale)._weekdaysShort);
          }.bind(this));
        } else if (key == 'monthsShort') {
          this._loadLocaleMoment(locale, function() {
            this._setKey(elem, key, moment.localeData(locale)._months);
          }.bind(this));
        } else if (key == 'firstDayOfWeek') {
          this._loadLocaleMoment(locale, function() {
            this._setKey(elem, key, moment.localeData(locale)._week.dow);
          }.bind(this));
        } else if (key == 'today') {
          this._loadLocaleMoment(locale, function() {
            this._setKey(elem, key, moment.localeData(locale).calendar(Date.now()).replace(/(.+?) .*/,'$1'));
          }.bind(this));
        }
      },

      _loadScript: function(src, done) {
        if (_scriptsLoaded[src]) {
          done();
        } else {
          var scriptElem = document.createElement('script');
          scriptElem.src = src;
          scriptElem.addEventListener('load', done);
          document.head.appendChild(scriptElem);
          _scriptsLoaded[src] = scriptElem;
        }
      },

      _loadMoment: function(done) {
        this._loadScript(this.resolveUrl('../moment/min/moment.min.js'), done);
      },

      _loadLocaleMoment: function(locale, done) {
        this._loadMoment(function() {
          this._loadScript(this.resolveUrl('../moment/locale/' + locale + '.js'), done);
        });
      },


    });
    </script>
  </dom-module>
